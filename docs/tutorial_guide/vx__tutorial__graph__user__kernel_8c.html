<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>TIOVX Tutorials: vx_tutorial_graph_user_kernel.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ti_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">TIOVX Tutorials
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('vx__tutorial__graph__user__kernel_8c.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">vx_tutorial_graph_user_kernel.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;stdio.h&gt;</code><br/>
<code>#include &lt;VX/vx.h&gt;</code><br/>
<code>#include &lt;TI/tivx.h&gt;</code><br/>
<code>#include &lt;<a class="el" href="utility_8h_source.html">utility.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="phase__rgb__user__kernel_8h_source.html">ch03_graph/phase_rgb_user_kernel.h</a>&gt;</code><br/>
</div>
<p><a href="vx__tutorial__graph__user__kernel_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a8118656bb5a60090a1dbffa402168438"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vx__tutorial__graph__user__kernel_8c.html#a8118656bb5a60090a1dbffa402168438">IN_FILE_NAME</a>&#160;&#160;&#160;&quot;vx_tutorial_graph_image_gradients_phase_out.bmp&quot;</td></tr>
<tr class="memdesc:a8118656bb5a60090a1dbffa402168438"><td class="mdescLeft">&#160;</td><td class="mdescRight">Input file name.  <a href="#a8118656bb5a60090a1dbffa402168438">More...</a><br/></td></tr>
<tr class="separator:a8118656bb5a60090a1dbffa402168438"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a858679d8af857cbb2c1346f4a4bc1c06"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vx__tutorial__graph__user__kernel_8c.html#a858679d8af857cbb2c1346f4a4bc1c06">OUT_USER_KERNEL_FILE_NAME</a>&#160;&#160;&#160;&quot;vx_tutorial_graph_user_kernel_out.bmp&quot;</td></tr>
<tr class="memdesc:a858679d8af857cbb2c1346f4a4bc1c06"><td class="mdescLeft">&#160;</td><td class="mdescRight">Output file name when tutorial is run with user kernel.  <a href="#a858679d8af857cbb2c1346f4a4bc1c06">More...</a><br/></td></tr>
<tr class="separator:a858679d8af857cbb2c1346f4a4bc1c06"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9a1d52660f6cc470b9da80d5589808fc"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vx__tutorial__graph__user__kernel_8c.html#a9a1d52660f6cc470b9da80d5589808fc">OUT_TARGET_KERNEL_FILE_NAME</a>&#160;&#160;&#160;&quot;vx_tutorial_graph_target_kernel_out.bmp&quot;</td></tr>
<tr class="memdesc:a9a1d52660f6cc470b9da80d5589808fc"><td class="mdescLeft">&#160;</td><td class="mdescRight">Output file name when tutorial is run with target kernel.  <a href="#a9a1d52660f6cc470b9da80d5589808fc">More...</a><br/></td></tr>
<tr class="separator:a9a1d52660f6cc470b9da80d5589808fc"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a8820fe10988a7eae08a86a7abd6308ea"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="vx__tutorial__graph__user__kernel_8c.html#a8820fe10988a7eae08a86a7abd6308ea">vx_tutorial_graph_user_kernel</a> (vx_bool add_as_target_kernel)</td></tr>
<tr class="memdesc:a8820fe10988a7eae08a86a7abd6308ea"><td class="mdescLeft">&#160;</td><td class="mdescRight">Tutorial Entry Point.  <a href="#a8820fe10988a7eae08a86a7abd6308ea">More...</a><br/></td></tr>
<tr class="separator:a8820fe10988a7eae08a86a7abd6308ea"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Show example usage of developing and invoking a user kernel</p>
<p>OpenVX allows users to define their own nodes called <b> user kernels </b> and provides an API to implement and invoke these user kernels. Once defined and implemented, user kernels can be added as any other node in an OpenVX graph</p>
<p>OpenVX user kernels need to run on the "HOST" CPU, i.e CPU where OpenVX APIs are invoked. This can be limiting for users who want to exploit performnance of specialized targets, like DSP, to execute their own functions. For this purpose, TIOVX specifies an API to define and implement <b> "target kernels" </b>. Like user kernels, once a target kernel is defined and implemented on a target (ex, DSP), it can be invoked as a normal node in an OpenVX graph using standard OpenVX APIs.</p>
<p>Most of the host side logic remains same for both user kernel and target kernel. For target kernel, additional target specific implementation is required on the required on target.</p>
<p>In this tutorial we learn below concepts,</p>
<ul>
<li>Firstly, implement an OpenVX user kernel on HOST CPU</li>
<li>Invoke it as a single node OpenVX graph to test the user kernel in standalone mode</li>
<li>Next, implement target kernel on DSP for the same user kernel function</li>
<li>Modify the HOST side logic to use target kernel instead of user kernel</li>
<li>Invoke the same single node graph but this time with the target kernel</li>
</ul>
<p>The custom kernel (user or target) we define in this tutorial does the below,</p>
<ul>
<li>Take 16b signed phase image as input</li>
<li>Generate a 24b RGB image with different colors representing different phase values</li>
</ul>
<p><b>NOTE: </b> Make sure to run <a class="el" href="vx__tutorial__graph__image__gradients_8c.html">vx_tutorial_graph_image_gradients.c</a> before running this tutorial, since output file from <a class="el" href="vx__tutorial__graph__image__gradients_8c.html">vx_tutorial_graph_image_gradients.c</a> is used as input by this tutorial</p>
<dl class="section user"><dt>Implementing a User Kernel</dt><dd><ul>
<li>Follow comments in file <a class="el" href="phase__rgb__user__kernel_8c.html">phase_rgb_user_kernel.c</a> to understand how to implement a user kernel</li>
<li>Follow comments in the function <a class="el" href="vx__tutorial__graph__user__kernel_8c.html#a8820fe10988a7eae08a86a7abd6308ea" title="Tutorial Entry Point. ">vx_tutorial_graph_user_kernel()</a> to understand how to register the implemented user kernel and invoke it as a user graph.</li>
</ul>
</dd></dl>
<dl class="section user"><dt>Implementing a Target Kernel on C66x DSP</dt><dd><ul>
<li>For target kernel, there are two parts to the implementation, HOST side implementation and target side implementation</li>
<li>Target side implementation<ul>
<li>Follow comments in <a class="el" href="phase__rgb__target__kernel_8c.html">phase_rgb_target_kernel.c</a> for target side implementation</li>
</ul>
</li>
<li><p class="startli">HOST side implementation</p>
<ul>
<li>Follow comments in file <a class="el" href="phase__rgb__user__kernel_8c.html">phase_rgb_user_kernel.c</a> to understand how to implement the HOST side portion of target kernel</li>
<li>Follow comments in the function <a class="el" href="vx__tutorial__graph__user__kernel_8c.html#a8820fe10988a7eae08a86a7abd6308ea" title="Tutorial Entry Point. ">vx_tutorial_graph_user_kernel()</a> to understand how to register the implemented target kernel and invoke it as a user graph.</li>
</ul>
<p class="startli"><b> NOTE: </b> <br/>
 The implementation on HOST side for user kernel and target kernel is largely the same. Any difference in implementation between user kernel and target kernel is shown by using using boolen variable 'add_as_target_kernel'.</p>
<ul>
<li>When 'add_as_target_kernel' is 'vx_false_e', it is the implementation for user kernel.</li>
<li>When 'add_as_target_kernel' is 'vx_true_e', it is the implementation for target kernel.</li>
</ul>
</li>
</ul>
</dd></dl>
<p>Include below file to use the HOST callable interface for the user/target kernel </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="phase__rgb__user__kernel_8h.html">ch03_graph/phase_rgb_user_kernel.h</a>&gt;</span></div>
</div><!-- fragment --> 
<p>Definition in file <a class="el" href="vx__tutorial__graph__user__kernel_8c_source.html">vx_tutorial_graph_user_kernel.c</a>.</p>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a class="anchor" id="a8118656bb5a60090a1dbffa402168438"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define IN_FILE_NAME&#160;&#160;&#160;&quot;vx_tutorial_graph_image_gradients_phase_out.bmp&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Input file name. </p>

<p>Definition at line <a class="el" href="vx__tutorial__graph__user__kernel_8c_source.html#l00137">137</a> of file <a class="el" href="vx__tutorial__graph__user__kernel_8c_source.html">vx_tutorial_graph_user_kernel.c</a>.</p>

</div>
</div>
<a class="anchor" id="a858679d8af857cbb2c1346f4a4bc1c06"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OUT_USER_KERNEL_FILE_NAME&#160;&#160;&#160;&quot;vx_tutorial_graph_user_kernel_out.bmp&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Output file name when tutorial is run with user kernel. </p>

<p>Definition at line <a class="el" href="vx__tutorial__graph__user__kernel_8c_source.html#l00140">140</a> of file <a class="el" href="vx__tutorial__graph__user__kernel_8c_source.html">vx_tutorial_graph_user_kernel.c</a>.</p>

</div>
</div>
<a class="anchor" id="a9a1d52660f6cc470b9da80d5589808fc"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OUT_TARGET_KERNEL_FILE_NAME&#160;&#160;&#160;&quot;vx_tutorial_graph_target_kernel_out.bmp&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Output file name when tutorial is run with target kernel. </p>

<p>Definition at line <a class="el" href="vx__tutorial__graph__user__kernel_8c_source.html#l00143">143</a> of file <a class="el" href="vx__tutorial__graph__user__kernel_8c_source.html">vx_tutorial_graph_user_kernel.c</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a8820fe10988a7eae08a86a7abd6308ea"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void vx_tutorial_graph_user_kernel </td>
          <td>(</td>
          <td class="paramtype">vx_bool&#160;</td>
          <td class="paramname"><em>add_as_target_kernel</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Tutorial Entry Point. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">add_as_target_kernel</td><td>[in] 'vx_false_e', run this tutorial with custom kernel running as user kernel <br/>
 'vx_true_e', run this tutorial with custom kernel running as target kernel <br/>
</td></tr>
  </table>
  </dd>
</dl>
<ul>
<li>Define OpenVX object references required to invoke the user/target kernel</li>
</ul>
<p>We need an OpenVX context, a graph to execute the node, a node to invoke the user target/kernel, and input/output image for the node. </p>
<div class="fragment"><div class="line">  /</div>
<div class="line">vx_context context;</div>
<div class="line">vx_image in_image = NULL;</div>
<div class="line">vx_image out_image = NULL;</div>
<div class="line">vx_node node = NULL;</div>
<div class="line">vx_graph graph = NULL;</div>
</div><!-- fragment --><ul>
<li>Specify the output file name</li>
</ul>
<p>In order to compare and confirm that the user kernel and target kernel generate the same output we specify a different output file for user and target kernel</p>
<div class="fragment"><div class="line">  /</div>
<div class="line"><span class="keywordtype">char</span> *out_file = <a class="code" href="vx__tutorial__graph__user__kernel_8c.html#a858679d8af857cbb2c1346f4a4bc1c06">OUT_USER_KERNEL_FILE_NAME</a>;</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span>(add_as_target_kernel)</div>
<div class="line">{</div>
<div class="line">    out_file = <a class="code" href="vx__tutorial__graph__user__kernel_8c.html#a9a1d52660f6cc470b9da80d5589808fc">OUT_TARGET_KERNEL_FILE_NAME</a>;</div>
<div class="line">}</div>
</div><!-- fragment --><ul>
<li>Create OpenVX context</li>
</ul>
<div class="fragment"><div class="line">  /</div>
<div class="line">context = vxCreateContext();</div>
</div><!-- fragment --><ul>
<li>Register user or target kernel into the OpenVX context</li>
</ul>
<p>This is required so that the user kernel or target can be invoked as any other node within an OpenVX graph. 'add_as_target_kernel' is used specify whether to register kernel as user kernel or target kernel.</p>
<p>This function is implemented in <a class="el" href="phase__rgb__user__kernel_8c.html">phase_rgb_user_kernel.c</a></p>
<p><b> Rest of the implementation post this is same for both user kernel and target kernel. </b> </p>
<div class="fragment"><div class="line">  /</div>
<div class="line">status = <a class="code" href="phase__rgb__user__kernel_8c.html#a5e51581ab691a0e9037aed069be8495b">phase_rgb_user_kernel_add</a>(context, add_as_target_kernel);</div>
<div class="line"><span class="keywordflow">if</span>(status!=VX_SUCCESS)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot; vx_tutorial_graph_user_kernel: ERROR: unable to add user kernel !!!\n&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><ul>
<li>Create input image and load input data into it</li>
</ul>
<p>A name is given to the input image object via vxSetReferenceName. Image attributes are shown for informative purpose and width x height queried for later use.</p>
<div class="fragment"><div class="line">  /</div>
<div class="line">in_image = <a class="code" href="utility_8h.html#af8e9cbbd49ab0dec7850267224548cd6">create_image_from_file</a>(context, <a class="code" href="vx__tutorial__image__load__save_8c.html#a8118656bb5a60090a1dbffa402168438">IN_FILE_NAME</a>, vx_true_e);</div>
<div class="line">vxSetReferenceName((vx_reference)in_image, <span class="stringliteral">&quot;INPUT&quot;</span>);</div>
<div class="line"><a class="code" href="utility_8h.html#ade45042efce712b30cf8254a6c90b3bc">show_image_attributes</a>(in_image);</div>
<div class="line"></div>
<div class="line">vxQueryImage(in_image, VX_IMAGE_WIDTH, &amp;width, <span class="keyword">sizeof</span>(vx_uint32));</div>
<div class="line">vxQueryImage(in_image, VX_IMAGE_HEIGHT, &amp;height, <span class="keyword">sizeof</span>(vx_uint32));</div>
</div><!-- fragment --><ul>
<li>Create output image</li>
</ul>
<p>Output image dimensions as same as input image. </p>
<div class="fragment"><div class="line">  /</div>
<div class="line">out_image = vxCreateImage(context, width, height, VX_DF_IMAGE_RGB);</div>
<div class="line">vxSetReferenceName((vx_reference)out_image, <span class="stringliteral">&quot;OUTPUT&quot;</span>);</div>
<div class="line"><a class="code" href="utility_8h.html#ade45042efce712b30cf8254a6c90b3bc">show_image_attributes</a>(out_image);</div>
</div><!-- fragment --><ul>
<li>Create a graph object to execute the user/target kernel node</li>
</ul>
<div class="fragment"><div class="line">  /</div>
<div class="line">graph = vxCreateGraph(context);</div>
</div><!-- fragment --><ul>
<li>Create a node for the registered user/target kernel and insert into the graph</li>
</ul>
<p>This function is implemented in <a class="el" href="phase__rgb__user__kernel_8c.html">phase_rgb_user_kernel.c</a> </p>
<div class="fragment"><div class="line">  /</div>
<div class="line">node = <a class="code" href="phase__rgb__user__kernel_8c.html#a88488bc22b7681a4c2ad9cc7e80bd214">phase_rgb_user_kernel_node</a>(graph, in_image, out_image);</div>
</div><!-- fragment --><ul>
<li>Verify and excute the graph using standard OpenVX APIs</li>
</ul>
<p>Ouptut image is saved to specified output file. </p>
<div class="fragment"><div class="line">  /</div>
<div class="line">status = vxVerifyGraph(graph);</div>
<div class="line"></div>
<div class="line"><a class="code" href="utility_8h.html#a86ae0d04d187710cc2d10f85bccb6e5d">show_graph_attributes</a>(graph);</div>
<div class="line"><a class="code" href="utility_8h.html#a4576aae15198e9645228f21be4290cff">show_node_attributes</a>(node);</div>
<div class="line"></div>
<div class="line">tivxExportGraphToDot(graph, <span class="stringliteral">&quot;.&quot;</span>, <span class="stringliteral">&quot;vx_tutorial_graph_user_kernel&quot;</span>);</div>
</div><!-- fragment --><ul>
<li>Release image, node, graph objects</li>
</ul>
<div class="fragment"><div class="line">  /</div>
<div class="line">vxReleaseImage(&amp;in_image);</div>
<div class="line">vxReleaseImage(&amp;out_image);</div>
<div class="line">vxReleaseNode(&amp;node);</div>
<div class="line">vxReleaseGraph(&amp;graph);</div>
</div><!-- fragment --><ul>
<li>Unregister user/kernel from the context</li>
</ul>
<p>This function is implemented in <a class="el" href="phase__rgb__user__kernel_8c.html">phase_rgb_user_kernel.c</a> </p>
<div class="fragment"><div class="line">  /</div>
<div class="line"><a class="code" href="phase__rgb__user__kernel_8c.html#a25ca1ab2d5d29d7d84d81ddc366a464c">phase_rgb_user_kernel_remove</a>(context);</div>
</div><!-- fragment --><ul>
<li>Finally release the OpenVX context</li>
</ul>
<div class="fragment"><div class="line">  /</div>
<div class="line">vxReleaseContext(&amp;context);</div>
</div><!-- fragment --> 
<p>Definition at line <a class="el" href="vx__tutorial__graph__user__kernel_8c_source.html#l00151">151</a> of file <a class="el" href="vx__tutorial__graph__user__kernel_8c_source.html">vx_tutorial_graph_user_kernel.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_07c2df013bb20677b8e65a9f18968d2c.html">tutorial</a></li><li class="navelem"><a class="el" href="dir_307a8bb882813a7025380ea070a5f4d7.html">ch03_graph</a></li><li class="navelem"><a class="el" href="vx__tutorial__graph__user__kernel_8c.html">vx_tutorial_graph_user_kernel.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
